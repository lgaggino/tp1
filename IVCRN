library(readxl)
library(dplyr)
library(tidyr)

data_tp <- read_excel("data_tp1.xlsx")

# Calcula totales anuales x paÃ­s
totales <- data_tp %>%
  group_by(Year, ReporterName) %>%
  summarise(Total_TradeValue = sum(`TradeValue in 1000 USD`, na.rm = TRUE)) %>%
  ungroup()

data_totales <- merge(data_tp, totales, by = c("Year", "ReporterName"))

# Calcula el porcentaje del v.c.
data_totales <- data_totales %>%
  mutate(porcentaje = (`TradeValue in 1000 USD` / Total_TradeValue) * 100)

# Calcula total mundial
totales_mundiales <- data_totales %>%
  group_by(Year, ProductCode) %>%
  summarise(global = sum(`TradeValue in 1000 USD`, na.rm = TRUE)) %>%
  mutate(prop = (global / sum(global)) * 100) %>%
  ungroup()

data_final <- merge(data_totales, totales_mundiales, by = c("Year", "ProductCode"))

# Calcular RCA y RCA Normalizado
data_final <- data_final %>%
  mutate(RCA = porcentaje / prop)

data_final <- data_final %>%
  mutate(RCA_Normalizado = (RCA - 1) / (RCA + 1))

# Ordenar datos y obtener top5
data_final <- data_final %>%
  group_by(Year, ProductCode, ReporterName) %>%
  summarise(RCA_Normalizado = mean(RCA_Normalizado, na.rm = TRUE), .groups = "drop")

productos_con_ventaja <- data_final %>%
  filter(ReporterName %in% c("Argentina", "Malaysia")) %>%
  pivot_wider(names_from = ReporterName, values_from = RCA_Normalizado) %>%
  filter(Argentina > Malaysia & Argentina > 0) %>%
  select(Year, ProductCode, Argentina, Malaysia)

top_5_productos <- productos_con_ventaja %>%
  group_by(Year) %>%
  arrange(desc(Argentina)) %>%
  slice_max(order_by = Argentina, n = 5, with_ties = FALSE) %>%
  ungroup()
